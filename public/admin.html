<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MECWISH Admin - Dashboard</title>

  <!-- Main CSS (Vite will process this) -->
  <link rel="stylesheet" href="../src/styles/main.css" />

  <!-- AlpineJS - Load immediately without defer -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js"></script>
  
  <style>
    /* Fallback styles if Tailwind doesn't load */
    [x-cloak] { display: none !important; }
    
    .bg-gray-50 { background-color: #f9fafb; }
    .bg-white { background-color: white; }
    .text-primary { color: #3b82f6; }
    .shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
    .rounded-xl { border-radius: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .font-bold { font-weight: 700; }
    .min-h-screen { min-height: 100vh; }
    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .text-center { text-align: center; }
    .max-w-md { max-width: 28rem; }
    .w-full { width: 100%; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .border { border: 1px solid #e5e7eb; }
    .rounded-lg { border-radius: 0.5rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .bg-blue-600 { background-color: #2563eb; }
    .text-white { color: white; }
    .text-gray-500 { color: #6b7280; }
    .text-red-600 { color: #dc2626; }
    .bg-red-50 { background-color: #fef2f2; }
    .border-red-200 { border-color: #fecaca; }
    .text-sm { font-size: 0.875rem; }
    .text-xs { font-size: 0.75rem; }
    .text-gray-400 { color: #9ca3af; }
  </style>
</head>

<body class="bg-gray-50" x-data="adminApp" x-init="init()"

  <!-- ================= LOGIN SCREEN ================= -->
  <div
    x-show="!isAuthenticated"
    x-cloak
    class="min-h-screen flex items-center justify-center p-4"
  >
    <div class="w-full max-w-md bg-white rounded-xl shadow p-6">
      <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-primary mb-2">MECWISH Admin</h1>
        <p class="text-gray-500">Đăng nhập để quản trị hệ thống</p>
      </div>

      <form @submit.prevent="handleLogin" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input
            type="email"
            x-model="loginForm.email"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="admin@mecwish.com"
            required
          />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Mật khẩu</label>
          <input
            type="password"
            x-model="loginForm.password"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="••••••••"
            required
          />
        </div>

        <div
          x-show="loginError"
          class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-600"
          x-text="loginError"
        ></div>

        <button
          type="submit"
          class="w-full py-2 rounded-lg bg-blue-600 text-white font-medium"
          :disabled="isLoggingIn"
        >
          <span x-show="!isLoggingIn">Đăng nhập</span>
          <span x-show="isLoggingIn">Đang đăng nhập...</span>
        </button>

        <div class="text-xs text-center text-gray-400">
          Demo: admin@mecwish.com / admin123
        </div>
      </form>
    </div>
  </div>

  <!-- ================= ADMIN LAYOUT ================= -->
  <div x-show="isAuthenticated" x-cloak class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r flex flex-col">
      <div class="p-6 border-b">
        <h1 class="text-2xl font-bold text-primary">MECWISH</h1>
        <p class="text-xs text-gray-500">Admin Dashboard</p>
      </div>

      <nav class="flex-1 p-4 space-y-1">
        <a href="#/" class="nav-item" :class="{ active: currentRoute === '/' }">Dashboard</a>
        <a href="#/products" class="nav-item" :class="{ active: currentRoute === '/products' }">Sản phẩm</a>
        <a href="#/orders" class="nav-item" :class="{ active: currentRoute === '/orders' }">Đơn hàng</a>
        <a href="#/customers" class="nav-item" :class="{ active: currentRoute === '/customers' }">Khách hàng</a>
        <a href="#/pools" class="nav-item" :class="{ active: currentRoute === '/pools' }">Kho Key</a>
        <a href="#/settings" class="nav-item" :class="{ active: currentRoute === '/settings' }">Cài đặt</a>
      </nav>

      <div class="p-4 border-t flex items-center justify-between">
        <div>
          <div class="text-sm font-medium" x-text="user?.name || 'Admin'"></div>
          <div class="text-xs text-gray-500" x-text="user?.email"></div>
        </div>
        <button @click="handleLogout" class="text-sm text-red-500">Logout</button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-8">
      <div id="app-content">
        <h2 class="text-2xl font-bold mb-2">Đang tải...</h2>
        <p class="text-gray-500">Vui lòng chờ trong giây lát</p>
      </div>
    </main>

  </div>

  <!-- ================= ERROR FALLBACK ================= -->
  <div id="error-fallback" style="display: none;">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; background-color: #f9fafb;">
      <div style="max-width: 28rem; width: 100%; background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.5rem;">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <h1 style="font-size: 1.875rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.5rem;">MECWISH Admin</h1>
          <p style="color: #6b7280;">Hệ thống đang khởi động...</p>
        </div>
        
        <div id="loading-status" style="padding: 1rem; background: #eff6ff; border-radius: 0.5rem; margin-bottom: 1rem;">
          <p style="color: #3b82f6; font-size: 0.875rem;">⏳ Đang tải các module...</p>
        </div>

        <div id="error-message" style="display: none; padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; color: #dc2626; font-size: 0.875rem; margin-bottom: 1rem;"></div>
        
        <button onclick="location.reload()" style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; background: #2563eb; color: white; font-weight: 500; border: none; cursor: pointer;">
          Tải lại trang
        </button>

        <div style="margin-top: 1rem; text-align: center; font-size: 0.75rem; color: #9ca3af;">
          Nếu vấn đề vẫn tiếp diễn, vui lòng kiểm tra Console (F12)
        </div>
      </div>
    </div>
  </div>

  <!-- ================= INITIALIZATION SCRIPT ================= -->
  <script>
    // Show error fallback if Alpine.js doesn't load in 5 seconds
    let fallbackTimer = setTimeout(() => {
      console.error('[Admin] Alpine.js or App initialization timeout');
      document.getElementById('error-fallback').style.display = 'block';
      document.getElementById('loading-status').innerHTML = '<p style="color: #dc2626; font-size: 0.875rem;">⚠️ Lỗi tải ứng dụng</p>';
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').innerHTML = 'Không thể khởi tạo ứng dụng. Có thể do lỗi mạng hoặc file JavaScript bị thiếu.';
    }, 5000);

    // Listen for Alpine initialization
    document.addEventListener('alpine:init', () => {
      console.log('[Admin] Alpine.js initialized successfully');
      clearTimeout(fallbackTimer);
    });

    // Check if Alpine is loaded
    window.addEventListener('load', () => {
      if (typeof Alpine === 'undefined') {
        console.error('[Admin] Alpine.js not loaded!');
        clearTimeout(fallbackTimer);
        document.getElementById('error-fallback').style.display = 'block';
        document.getElementById('error-message').style.display = 'block';
        document.getElementById('error-message').innerHTML = 'Alpine.js không được tải. Vui lòng kiểm tra kết nối mạng.';
      }
    });

    // Global error handler
    window.addEventListener('error', (e) => {
      console.error('[Admin] Runtime error:', e.error);
      if (e.error && e.error.message) {
        const errorDiv = document.getElementById('error-message');
        if (errorDiv) {
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = 'Lỗi: ' + e.error.message;
        }
      }
    });
  </script>

  <!-- ================= MAIN ENTRY ================= -->
  <script type="module" src="../src/main.js"></script>

</body>
</html>